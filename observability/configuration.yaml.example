# Example configuration.yaml entries for Home Agent Observability
#
# INSTRUCTIONS:
# 1. Copy the sections below into your configuration.yaml
# 2. Restart Home Assistant
# 3. Have a conversation with Home Agent to populate the sensors
#
# NOTE: Do NOT copy the "automation:" section to configuration.yaml if you
# already use automations.yaml. Instead, copy those to automations.yaml.

# =============================================================================
# TEMPLATE SENSORS - Tracks real-time metrics from each conversation
# =============================================================================
template:
  - trigger:
      - platform: event
        event_type: home_agent.conversation.finished
      - platform: event
        event_type: home_agent.tool.executed
      - platform: event
        event_type: home_agent.error
    sensor:
      # Conversation metrics
      - name: "Home Agent Last Conversation Duration"
        unique_id: home_agent_last_conversation_duration
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.duration_ms }}
          {% else %}
            {% set current = states('sensor.home_agent_last_conversation_duration') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "ms"
        state_class: measurement

      - name: "Home Agent Last Conversation Tokens"
        unique_id: home_agent_last_conversation_tokens
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.tokens.total }}
          {% else %}
            {% set current = states('sensor.home_agent_last_conversation_tokens') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "tokens"
        state_class: measurement
        attributes:
          prompt_tokens: >
            {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
              {{ trigger.event.data.tokens.prompt }}
            {% endif %}
          completion_tokens: >
            {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
              {{ trigger.event.data.tokens.completion }}
            {% endif %}

      - name: "Home Agent Last LLM Latency"
        unique_id: home_agent_last_llm_latency
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.performance.llm_latency_ms }}
          {% else %}
            {% set current = states('sensor.home_agent_last_llm_latency') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "ms"
        state_class: measurement

      - name: "Home Agent Last Tool Latency"
        unique_id: home_agent_last_tool_latency
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.performance.tool_latency_ms }}
          {% else %}
            {% set current = states('sensor.home_agent_last_tool_latency') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "ms"
        state_class: measurement

      - name: "Home Agent Last Context Latency"
        unique_id: home_agent_last_context_latency
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.performance.context_latency_ms }}
          {% else %}
            {% set current = states('sensor.home_agent_last_context_latency') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "ms"
        state_class: measurement

      - name: "Home Agent Last TTFT"
        unique_id: home_agent_last_ttft
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.performance.ttft_ms }}
          {% else %}
            {% set current = states('sensor.home_agent_last_ttft') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "ms"
        state_class: measurement

      - name: "Home Agent Last Tool Calls"
        unique_id: home_agent_last_tool_calls
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ trigger.event.data.tool_calls }}
          {% else %}
            {% set current = states('sensor.home_agent_last_tool_calls') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "calls"
        state_class: measurement

      - name: "Home Agent Used External LLM"
        unique_id: home_agent_used_external_llm
        state: >
          {% if trigger.event.event_type == 'home_agent.conversation.finished' %}
            {{ 1 if trigger.event.data.used_external_llm else 0 }}
          {% else %}
            {% set current = states('sensor.home_agent_used_external_llm') %}
            {{ current if current not in ['unknown', 'unavailable'] else 0 }}
          {% endif %}
        unit_of_measurement: "boolean"
        state_class: measurement

# =============================================================================
# COUNTER HELPERS - Persistent counters that survive restarts
# =============================================================================
counter:
  home_agent_conversations_total:
    name: "Home Agent Conversations Total"
    icon: mdi:chat
  home_agent_tool_successes:
    name: "Home Agent Tool Successes"
    icon: mdi:check-circle
  home_agent_tool_failures:
    name: "Home Agent Tool Failures"
    icon: mdi:alert-circle
  home_agent_errors_total:
    name: "Home Agent Errors Total"
    icon: mdi:alert

# =============================================================================
# AUTOMATIONS - Increment counters when events fire
#
# ⚠️ IMPORTANT: If you use automations.yaml (most common), DO NOT add this
# section here. Instead, copy the automation entries (without the
# "automation:" line) to your automations.yaml file.
#
# See automations.yaml.example for the correct format.
# =============================================================================
# Uncomment the section below ONLY if you configure automations in
# configuration.yaml (not common):
#
# automation:
#   - id: home_agent_conversation_counter
#     alias: "Home Agent: Increment Conversation Counter"
#     trigger:
#       - platform: event
#         event_type: home_agent.conversation.finished
#     action:
#       - service: counter.increment
#         target:
#           entity_id: counter.home_agent_conversations_total
#
#   - id: home_agent_tool_counter
#     alias: "Home Agent: Track Tool Success/Failure"
#     trigger:
#       - platform: event
#         event_type: home_agent.tool.executed
#     action:
#       - choose:
#           - conditions:
#               - condition: template
#                 value_template: "{{ trigger.event.data.success }}"
#             sequence:
#               - service: counter.increment
#                 target:
#                   entity_id: counter.home_agent_tool_successes
#         default:
#           - service: counter.increment
#             target:
#               entity_id: counter.home_agent_tool_failures
#
#   - id: home_agent_error_counter
#     alias: "Home Agent: Increment Error Counter"
#     trigger:
#       - platform: event
#         event_type: home_agent.error
#     action:
#       - service: counter.increment
#         target:
#           entity_id: counter.home_agent_errors_total

# =============================================================================
# INFLUXDB CONFIGURATION (if using InfluxDB for metrics)
# =============================================================================
# If you're already sending all entities to InfluxDB, you don't need this.
# If you have selective includes, add these entities:
#
# influxdb:
#   # ... your existing InfluxDB settings (host, port, token, etc.)
#   include:
#     entity_globs:
#       - sensor.home_agent_*
#       - counter.home_agent_*
#
# Or, if you prefer explicit entity list:
#
# influxdb:
#   # ... your existing settings
#   include:
#     entities:
#       - sensor.home_agent_last_conversation_duration
#       - sensor.home_agent_last_conversation_tokens
#       - sensor.home_agent_last_llm_latency
#       - sensor.home_agent_last_tool_latency
#       - sensor.home_agent_last_context_latency
#       - sensor.home_agent_last_ttft
#       - sensor.home_agent_last_tool_calls
#       - sensor.home_agent_used_external_llm
#       - counter.home_agent_conversations_total
#       - counter.home_agent_tool_successes
#       - counter.home_agent_tool_failures
#       - counter.home_agent_errors_total
